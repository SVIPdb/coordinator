version: '3.5'

# generic compose config where nginx is the entrypoint
# site-specific configs should use this config and additionaly one from ./sites, e.g.:
# docker-compose -f docker-compose.yml -f compose/prod.yml -f compose/sites/svip-dev.yml "$@"

services:
  nginx:
    build:
      context: ./service_config/nginx
      dockerfile: Dockerfile
    volumes:
      - '${PWD}/service_config/nginx/shared.conf:/etc/nginx/shared.conf:ro'
      - '${PWD}/service_config/nginx/sites/local.nginx:/etc/nginx/conf.d/svip.nginx:ro'
      - 'web_built:/usr/share/nginx/html'
      - 'api_static:/usr/share/api_static'
    ports:
      - '8020:80'
    depends_on:
      - api
      - frontend

  api:
    build:
      context: ./svip_api
      args:
        requirefile: requirements.prod.txt
    volumes:
      - api_static:/app/static
    environment:
      # - POSTGRES_DB=svip_api
      - USE_DEV_SERVER=
      - DJANGO_SETTINGS_MODULE=svip_server.settings.production

  frontend:
    build:
      context: ./svip-o-vue
      dockerfile: Dockerfile
      target: build-deps
    command: 'cp -R /app/dist/* /web'
    restart: 'no'
    environment:
      - 'VUE_APP_API_URL=http://localhost:8020/api/v1/'
